suite: Regression Test Migration
templates:
  - hooks/migration-env.yaml
  - hooks/migration.yaml
release:
  name: ut
tests:
  - it: When given a secretProvider, should always render volumeMounts and volumes for them
    set:
      tyk.listenPath: /unit-test
      image.tag: pinned-version
      secretProvider.tenantId: 99330c76-81xxxx
      secretProvider.vaults.qa-app-common.AMQP_URL: RABBITMQ-ORANGE-WOLF-URL
      hooks.migration.enabled: true
    template: hooks/migration.yaml
    asserts:
      - isKind:
          of: Job

      # Check if the volumes array exists in the template
      - isNotNullOrEmpty:
          path: spec.template.spec.volumes

      # Check if the specific volume `db-migration-qa-app-common` exists
      - isNotNullOrEmpty:
          path: spec.template.spec.volumes[?(@.name == "ut-qa-app-common")]

      # Check if the container array exists
      - isNotNullOrEmpty:
          path: spec.template.spec.containers

      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "db-migration")]

      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "db-migration")].volumeMounts

      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "db-migration")].volumeMounts[?(@.name == "ut-qa-app-common")]

      - equal:
          path: spec.template.spec.containers[?(@.name == "db-migration")].volumeMounts[?(@.name == "ut-qa-app-common")].mountPath
          value: "/mnt/ut-qa-app-common"

  - it: When given initContainers in migration
    set:
      tyk.listenPath: /unit-test
      image.tag: pinned-version
      hooks.migration.enabled: true
      hooks.migration.initContainers[0].command:
        - "sh"
        - "-e"
        - "echo"
        - "helloWorld"
    template: hooks/migration.yaml
    asserts:
      - isKind:
          of: Job
      - isNotNullOrEmpty:
          path: spec.template.spec.initContainers[0]
      - isNotNullOrEmpty:
          path: spec.template.spec.initContainers[?(@.name == "init-ut")]