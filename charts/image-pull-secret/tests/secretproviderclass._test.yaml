# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Regression Test Deployment
templates:
  - secretproviderclass.yaml
release:
  name: ut
tests:
  - it: When given a secretProvider, should always render volumeMounts and volumes for them
    set:
      spc:
        - name: my-spc
          keyvaultName: my-azure-kv
          install: true # If false the spc will not be created
          useVMManagedIdentity: "true"
          userAssignedIdentityID: "XXXXXX-XXXX-XXXX"
          tenantId: "xxxx-xxxx-xxxxxx-x"
          secrets:
            - name: my-secret-1
              type: Opaque
              labels:
                app: test-value
                env: dev
              data:
                - objectName: my-demo-secret-1
                  key: the-name-to-display-in-k8s
                  objectType: secret
                  objectVersion: ""

    template: secretproviderclass.yaml
    asserts:
      - isKind:
          of: SecretProviderClass
      - isNotNullOrEmpty:
          path: spec.parameters[?(@.keyvaultName == "my-azure-kv")]

      - isNotNullOrEmpty:
          path: spec.parameters.objects

      - isNotNullOrEmpty:
          path: spec.secretObjects[0].data[?(@.key == "the-name-to-display-in-k8s")]